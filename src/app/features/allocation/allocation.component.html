<div class="allocation-container">
  <!-- Header -->
  <div class="allocation-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="header-title">
          <mat-icon>groups</mat-icon>
          Alocação de Recursos
        </h1>
        <p class="header-subtitle">Gerencie a alocação de equipes e recursos em projetos</p>
      </div>
      <div class="header-actions">
        <button mat-stroked-button (click)="exportData()">
          <mat-icon>download</mat-icon>
          Exportar
        </button>
        <button mat-raised-button color="primary" (click)="openMemberDialog()">
          <mat-icon>person_add</mat-icon>
          Novo Membro
        </button>
        <button mat-raised-button color="primary" (click)="openAllocationDialog()">
          <mat-icon>assignment_ind</mat-icon>
          Nova Alocação
        </button>
      </div>
    </div>
  </div>

  <!-- Metrics Summary -->
  <div class="metrics-grid">
    <mat-card class="metric-card total">
      <mat-card-content>
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon>group</mat-icon>
          </div>
          <div class="metric-info">
            <div class="metric-value">{{ metrics.totalMembers }}</div>
            <div class="metric-label">Total de Membros</div>
            <div class="metric-trend positive">
              <mat-icon>trending_up</mat-icon>
              +2 este mês
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card available">
      <mat-card-content>
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon>person_outline</mat-icon>
          </div>
          <div class="metric-info">
            <div class="metric-value">{{ metrics.availableMembers }}</div>
            <div class="metric-label">Membros Disponíveis</div>
            <div class="metric-trend neutral">
              <mat-icon>remove</mat-icon>
              Sem alteração
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card utilization">
      <mat-card-content>
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon>timeline</mat-icon>
          </div>
          <div class="metric-info">
            <div class="metric-value">{{ metrics.utilizationRate | number:'1.1-1' }}%</div>
            <div class="metric-label">Taxa de Utilização</div>
            <div class="metric-trend positive">
              <mat-icon>trending_up</mat-icon>
              +5% esta semana
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card billable">
      <mat-card-content>
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon>attach_money</mat-icon>
          </div>
          <div class="metric-info">
            <div class="metric-value">{{ metrics.billableRate | number:'1.1-1' }}%</div>
            <div class="metric-label">Taxa Faturável</div>
            <div class="metric-trend positive">
              <mat-icon>trending_up</mat-icon>
              +3% este mês
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- View Controls -->
  <mat-card class="controls-card">
    <mat-card-content>
      <div class="controls-content">
        <div class="view-controls">
          <mat-button-toggle-group [(value)]="viewMode" (change)="onViewModeChange($event.value)">
            <mat-button-toggle value="grid">
              <mat-icon>grid_view</mat-icon>
              Grade
            </mat-button-toggle>
            <mat-button-toggle value="timeline">
              <mat-icon>timeline</mat-icon>
              Timeline
            </mat-button-toggle>
            <mat-button-toggle value="calendar">
              <mat-icon>calendar_month</mat-icon>
              Calendário
            </mat-button-toggle>
          </mat-button-toggle-group>
        </div>
        
        <div class="time-controls">
          <mat-button-toggle-group [(value)]="timeRange" (change)="onTimeRangeChange($event.value)">
            <mat-button-toggle value="week">Semana</mat-button-toggle>
            <mat-button-toggle value="month">Mês</mat-button-toggle>
            <mat-button-toggle value="quarter">Trimestre</mat-button-toggle>
          </mat-button-toggle-group>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Main Content Tabs -->
  <mat-card class="allocation-tabs">
    <mat-tab-group [(selectedIndex)]="selectedTab" (selectedTabChange)="onTabChange($event.index)">
      <!-- Team Members Tab -->
      <mat-tab label="Equipe">
        <div class="tab-content">
          <!-- Filters -->
          <div class="filters-section">
            <mat-form-field appearance="outline">
              <mat-label>Departamento</mat-label>
              <mat-select [(value)]="departmentFilter">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let dept of departments" [value]="dept">{{ dept }}</mat-option>
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Habilidade</mat-label>
              <mat-select [(value)]="skillFilter">
                <mat-option value="">Todas</mat-option>
                <mat-option *ngFor="let skill of skills" [value]="skill">{{ skill }}</mat-option>
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Status</mat-label>
              <mat-select [(value)]="statusFilter">
                <mat-option value="">Todos</mat-option>
                <mat-option value="available">Disponível</mat-option>
                <mat-option value="busy">Ocupado</mat-option>
                <mat-option value="unavailable">Indisponível</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Team Members Grid -->
          <div class="members-grid" *ngIf="viewMode === 'grid'">
            <mat-card class="member-card" *ngFor="let member of filteredMembers">
              <mat-card-header>
                <div mat-card-avatar class="member-avatar">
                  <mat-icon>person</mat-icon>
                </div>
                <mat-card-title>{{ member.name }}</mat-card-title>
                <mat-card-subtitle>{{ member.role }}</mat-card-subtitle>
                <div class="card-actions">
                  <button mat-icon-button [matMenuTriggerFor]="memberMenu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #memberMenu="matMenu">
                    <button mat-menu-item (click)="openMemberDialog(member)">
                      <mat-icon>edit</mat-icon>
                      Editar
                    </button>
                    <button mat-menu-item (click)="openAllocationDialog()">
                      <mat-icon>assignment_ind</mat-icon>
                      Alocar
                    </button>
                    <button mat-menu-item class="delete-action" (click)="deleteMember(member)">
                      <mat-icon>delete</mat-icon>
                      Excluir
                    </button>
                  </mat-menu>
                </div>
              </mat-card-header>
              
              <mat-card-content>
                <div class="member-info">
                  <div class="info-item">
                    <span class="info-label">Departamento:</span>
                    <span class="info-value">{{ member.department }}</span>
                  </div>
                  
                  <div class="info-item">
                    <span class="info-label">Localização:</span>
                    <span class="info-value">{{ member.location }}</span>
                  </div>
                  
                  <div class="info-item">
                    <span class="info-label">Taxa/Hora:</span>
                    <span class="info-value">R$ {{ member.hourlyRate }}</span>
                  </div>
                  
                  <div class="info-item">
                    <span class="info-label">Status:</span>
                    <mat-chip [style.background-color]="getStatusColor(member.status)" class="status-chip">
                      {{ member.status === 'available' ? 'Disponível' : member.status === 'busy' ? 'Ocupado' : 'Indisponível' }}
                    </mat-chip>
                  </div>
                </div>
                
                <div class="member-skills">
                  <div class="skills-label">Habilidades:</div>
                  <div class="skills-list">
                    <mat-chip *ngFor="let skill of member.skills">{{ skill }}</mat-chip>
                  </div>
                </div>
                
                <div class="member-utilization">
                  <div class="utilization-header">
                    <span>Utilização</span>
                    <span>{{ 100 - member.availability }}%</span>
                  </div>
                  <mat-progress-bar 
                    [value]="100 - member.availability" 
                    [class]="(100 - member.availability) > 80 ? 'high' : (100 - member.availability) > 60 ? 'medium' : 'low'">
                  </mat-progress-bar>
                </div>
                
                <div class="member-projects" *ngIf="member.currentProjects.length > 0">
                  <div class="projects-label">Projetos Atuais:</div>
                  <div class="projects-list">
                    <span *ngFor="let projectId of member.currentProjects" class="project-tag">
                      {{ getProjectName(projectId) }}
                    </span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </mat-tab>

      <!-- Allocations Tab -->
      <mat-tab label="Alocações">
        <div class="tab-content">
          <!-- Filters -->
          <div class="filters-section">
            <mat-form-field appearance="outline">
              <mat-label>Projeto</mat-label>
              <mat-select [(value)]="projectFilter">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let project of projects" [value]="project.id">{{ project.name }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Allocations Table -->
          <div class="table-container">
            <table mat-table [dataSource]="filteredAllocations" class="allocations-table">
              <ng-container matColumnDef="member">
                <th mat-header-cell *matHeaderCellDef>Membro</th>
                <td mat-cell *matCellDef="let allocation">
                  <div class="member-cell">
                    <div class="member-name">{{ getMemberName(allocation.memberId) }}</div>
                    <div class="member-role">{{ allocation.role }}</div>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="project">
                <th mat-header-cell *matHeaderCellDef>Projeto</th>
                <td mat-cell *matCellDef="let allocation">
                  {{ getProjectName(allocation.projectId) }}
                </td>
              </ng-container>

              <ng-container matColumnDef="period">
                <th mat-header-cell *matHeaderCellDef>Período</th>
                <td mat-cell *matCellDef="let allocation">
                  <div class="period-cell">
                    <div>{{ allocation.startDate | date:'dd/MM/yyyy' }}</div>
                    <div>{{ allocation.endDate | date:'dd/MM/yyyy' }}</div>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="hours">
                <th mat-header-cell *matHeaderCellDef>Horas/Semana</th>
                <td mat-cell *matCellDef="let allocation">
                  {{ allocation.hoursPerWeek }}h
                </td>
              </ng-container>

              <ng-container matColumnDef="rate">
                <th mat-header-cell *matHeaderCellDef>Taxa/Hora</th>
                <td mat-cell *matCellDef="let allocation">
                  R$ {{ allocation.hourlyRate }}
                </td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let allocation">
                  <mat-chip [style.background-color]="getStatusColor(allocation.status)">
                    {{ allocation.status === 'planned' ? 'Planejado' : 
                       allocation.status === 'active' ? 'Ativo' : 
                       allocation.status === 'completed' ? 'Concluído' : 'Cancelado' }}
                  </mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Ações</th>
                <td mat-cell *matCellDef="let allocation">
                  <button mat-icon-button [matMenuTriggerFor]="allocationMenu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #allocationMenu="matMenu">
                    <button mat-menu-item (click)="openAllocationDialog(allocation)">
                      <mat-icon>edit</mat-icon>
                      Editar
                    </button>
                    <button mat-menu-item class="delete-action" (click)="deleteAllocation(allocation)">
                      <mat-icon>delete</mat-icon>
                      Excluir
                    </button>
                  </mat-menu>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['member', 'project', 'period', 'hours', 'rate', 'status', 'actions']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['member', 'project', 'period', 'hours', 'rate', 'status', 'actions'];"></tr>
            </table>
          </div>
        </div>
      </mat-tab>

      <!-- Analytics Tab -->
      <mat-tab label="Análises">
        <div class="tab-content">
          <div class="analytics-grid">
            <!-- Utilization Chart -->
            <mat-card class="chart-card">
              <mat-card-header>
                <mat-card-title>Utilização por Membro</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="chart-container">
                  <canvas id="utilizationChart"></canvas>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Skills Demand Chart -->
            <mat-card class="chart-card">
              <mat-card-header>
                <mat-card-title>Demanda por Habilidades</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="chart-container">
                  <canvas id="skillsChart"></canvas>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Capacity Chart -->
            <mat-card class="chart-card full-width">
              <mat-card-header>
                <mat-card-title>Capacidade vs Alocação</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="chart-container">
                  <canvas id="capacityChart"></canvas>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Skills Gap Analysis -->
            <mat-card class="skills-gap-card">
              <mat-card-header>
                <mat-card-title>Análise de Gap de Habilidades</mat-card-title>
                <mat-card-subtitle>Identificação de lacunas de competências</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="skills-gap-list">
                  <div class="skill-gap-item" *ngFor="let skill of skillDemands.slice(0, 10)">
                    <div class="skill-info">
                      <div class="skill-name">{{ skill.skill }}</div>
                      <div class="skill-projects">{{ skill.projects.length }} projeto(s)</div>
                    </div>
                    <div class="skill-metrics">
                      <div class="metric">
                        <span class="metric-label">Demanda:</span>
                        <span class="metric-value demand">{{ skill.demand }}</span>
                      </div>
                      <div class="metric">
                        <span class="metric-label">Oferta:</span>
                        <span class="metric-value supply">{{ skill.supply }}</span>
                      </div>
                      <div class="metric">
                        <span class="metric-label">Gap:</span>
                        <span class="metric-value gap" [class]="skill.gap > 0 ? 'negative' : skill.gap < 0 ? 'positive' : 'neutral'">
                          {{ skill.gap > 0 ? '+' : '' }}{{ skill.gap }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-card>
</div>

<!-- Allocation Dialog -->
<div class="dialog-overlay" *ngIf="showAllocationDialog" (click)="closeAllocationDialog()">
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>{{ editingAllocation ? 'Editar Alocação' : 'Nova Alocação' }}</h2>
      <button mat-icon-button (click)="closeAllocationDialog()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <form [formGroup]="allocationForm" class="allocation-form">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Membro da Equipe</mat-label>
          <mat-select formControlName="memberId">
            <mat-option *ngFor="let member of teamMembers" [value]="member.id">
              {{ member.name }} - {{ member.role }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Projeto</mat-label>
          <mat-select formControlName="projectId">
            <mat-option *ngFor="let project of projects" [value]="project.id">
              {{ project.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      
      <mat-form-field appearance="outline">
        <mat-label>Função no Projeto</mat-label>
        <input matInput formControlName="role" placeholder="Ex: Desenvolvedor Frontend">
      </mat-form-field>
      
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Data de Início</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Data de Fim</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="endDate">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>
      
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Horas por Semana</mat-label>
          <input matInput type="number" formControlName="hoursPerWeek" min="1" max="60">
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Taxa por Hora (R$)</mat-label>
          <input matInput type="number" formControlName="hourlyRate" min="0">
        </mat-form-field>
      </div>
      
      <mat-form-field appearance="outline">
        <mat-label>Observações</mat-label>
        <textarea matInput formControlName="notes" rows="3" placeholder="Observações adicionais sobre a alocação"></textarea>
      </mat-form-field>
      
      <div class="dialog-actions">
        <button mat-button type="button" (click)="closeAllocationDialog()">Cancelar</button>
        <button mat-raised-button color="primary" type="button" (click)="saveAllocation()" [disabled]="!allocationForm.valid">
          {{ editingAllocation ? 'Atualizar' : 'Criar' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Member Dialog -->
<div class="dialog-overlay" *ngIf="showMemberDialog" (click)="closeMemberDialog()">
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>{{ editingMember ? 'Editar Membro' : 'Novo Membro' }}</h2>
      <button mat-icon-button (click)="closeMemberDialog()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <form [formGroup]="memberForm" class="member-form">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Nome Completo</mat-label>
          <input matInput formControlName="name" placeholder="Nome do membro da equipe">
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Cargo/Função</mat-label>
          <input matInput formControlName="role" placeholder="Ex: Desenvolvedor Senior">
        </mat-form-field>
      </div>
      
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Departamento</mat-label>
          <input matInput formControlName="department" placeholder="Ex: Engenharia">
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Taxa por Hora (R$)</mat-label>
          <input matInput type="number" formControlName="hourlyRate" min="0">
        </mat-form-field>
      </div>
      
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Localização</mat-label>
          <input matInput formControlName="location" placeholder="Ex: São Paulo">
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Fuso Horário</mat-label>
          <input matInput formControlName="timezone" placeholder="Ex: GMT-3">
        </mat-form-field>
      </div>
      
      <mat-form-field appearance="outline">
        <mat-label>Disponibilidade (%)</mat-label>
        <input matInput type="number" formControlName="availability" min="0" max="100">
        <mat-hint>Percentual de disponibilidade para novos projetos</mat-hint>
      </mat-form-field>
      
      <mat-form-field appearance="outline">
        <mat-label>Habilidades</mat-label>
        <mat-chip-grid #chipGrid>
          <mat-chip-row *ngFor="let skill of memberForm.get('skills')?.value || []" 
                       (removed)="removeSkill(skill)">
            {{ skill }}
            <button matChipRemove>
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip-row>
        </mat-chip-grid>
        <input placeholder="Digite uma habilidade e pressione Enter"
               [matChipInputFor]="chipGrid"
               (matChipInputTokenEnd)="addSkill($event)">
      </mat-form-field>
      
      <div class="dialog-actions">
        <button mat-button type="button" (click)="closeMemberDialog()">Cancelar</button>
        <button mat-raised-button color="primary" type="button" (click)="saveMember()" [disabled]="!memberForm.valid">
          {{ editingMember ? 'Atualizar' : 'Criar' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="loading">
  <mat-spinner></mat-spinner>
  <p>Carregando dados de alocação...</p>
</div>
<div class="financial-container">
  <!-- Header -->
  <div class="financial-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="header-title">
          <mat-icon>account_balance</mat-icon>
          Gestão Financeira
        </h1>
        <p class="header-subtitle">Controle financeiro e análise de custos</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="showTransactionDialog = true">
          <mat-icon>add</mat-icon>
          Nova Transação
        </button>
        <button mat-stroked-button (click)="exportReport()">
          <mat-icon>download</mat-icon>
          Exportar Relatório
        </button>
        <button mat-icon-button [matMenuTriggerFor]="headerMenu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #headerMenu="matMenu">
          <button mat-menu-item (click)="showBudgetDialog = true">
            <mat-icon>savings</mat-icon>
            Novo Orçamento
          </button>
          <button mat-menu-item (click)="showInvoiceDialog = true">
            <mat-icon>receipt</mat-icon>
            Nova Fatura
          </button>
          <mat-divider></mat-divider>
          <button mat-menu-item>
            <mat-icon>settings</mat-icon>
            Configurações
          </button>
        </mat-menu>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-grid">
    <mat-card class="summary-card income">
      <mat-card-content>
        <div class="summary-content">
          <div class="summary-icon">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="summary-info">
            <h3 class="summary-value">{{ formatCurrency(financialReport.totalIncome) }}</h3>
            <p class="summary-label">Receita Total</p>
            <span class="summary-trend positive">
              <mat-icon>arrow_upward</mat-icon>
              +12.5%
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card expense">
      <mat-card-content>
        <div class="summary-content">
          <div class="summary-icon">
            <mat-icon>trending_down</mat-icon>
          </div>
          <div class="summary-info">
            <h3 class="summary-value">{{ formatCurrency(financialReport.totalExpenses) }}</h3>
            <p class="summary-label">Despesas Totais</p>
            <span class="summary-trend negative">
              <mat-icon>arrow_downward</mat-icon>
              +8.3%
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card profit">
      <mat-card-content>
        <div class="summary-content">
          <div class="summary-icon">
            <mat-icon>account_balance_wallet</mat-icon>
          </div>
          <div class="summary-info">
            <h3 class="summary-value">{{ formatCurrency(financialReport.netProfit) }}</h3>
            <p class="summary-label">Lucro Líquido</p>
            <span class="summary-trend" [class.positive]="financialReport.netProfit > 0" [class.negative]="financialReport.netProfit < 0">
              <mat-icon>{{ financialReport.netProfit > 0 ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
              {{ formatPercentage(financialReport.profitMargin) }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card cashflow">
      <mat-card-content>
        <div class="summary-content">
          <div class="summary-icon">
            <mat-icon>waterfall_chart</mat-icon>
          </div>
          <div class="summary-info">
            <h3 class="summary-value">{{ formatCurrency(financialReport.cashFlow) }}</h3>
            <p class="summary-label">Fluxo de Caixa</p>
            <span class="summary-trend positive">
              <mat-icon>arrow_upward</mat-icon>
              +5.7%
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-form">
        <mat-form-field appearance="outline">
          <mat-label>Tipo</mat-label>
          <mat-select formControlName="type">
            <mat-option value="all">Todos</mat-option>
            <mat-option *ngFor="let type of transactionTypes" [value]="type.value">
              <mat-icon [style.color]="type.color">{{ type.icon }}</mat-icon>
              {{ type.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Categoria</mat-label>
          <mat-select formControlName="category">
            <mat-option value="all">Todas</mat-option>
            <mat-option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option value="all">Todos</mat-option>
            <mat-option *ngFor="let status of statusOptions" [value]="status.value">
              <span class="status-chip" [style.background-color]="status.color"></span>
              {{ status.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Período</mat-label>
          <mat-select formControlName="dateRange">
            <mat-option value="thisMonth">Este Mês</mat-option>
            <mat-option value="lastMonth">Mês Passado</mat-option>
            <mat-option value="thisQuarter">Este Trimestre</mat-option>
            <mat-option value="thisYear">Este Ano</mat-option>
            <mat-option value="custom">Personalizado</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button color="primary" type="button">
          <mat-icon>search</mat-icon>
          Filtrar
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Main Content Tabs -->
  <mat-tab-group [(selectedIndex)]="selectedTab" class="financial-tabs">
    <!-- Transações -->
    <mat-tab label="Transações">
      <div class="tab-content">
        <mat-card class="data-card">
          <mat-card-header>
            <mat-card-title>Transações Financeiras</mat-card-title>
            <mat-card-subtitle>{{ transactions.length }} transações encontradas</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="transactions" class="transactions-table">
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef>Data</th>
                  <td mat-cell *matCellDef="let transaction">{{ formatDate(transaction.date) }}</td>
                </ng-container>

                <ng-container matColumnDef="type">
                  <th mat-header-cell *matHeaderCellDef>Tipo</th>
                  <td mat-cell *matCellDef="let transaction">
                    <div class="type-cell">
                      <mat-icon [style.color]="getTransactionTypeInfo(transaction.type)?.color">
                        {{ getTransactionTypeInfo(transaction.type)?.icon }}
                      </mat-icon>
                      <span>{{ getTransactionTypeInfo(transaction.type)?.label }}</span>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="description">
                  <th mat-header-cell *matHeaderCellDef>Descrição</th>
                  <td mat-cell *matCellDef="let transaction">
                    <div class="description-cell">
                      <span class="description-text">{{ transaction.description }}</span>
                      <span class="description-meta" *ngIf="transaction.project">
                        Projeto: {{ transaction.project }}
                      </span>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="category">
                  <th mat-header-cell *matHeaderCellDef>Categoria</th>
                  <td mat-cell *matCellDef="let transaction">
                    <mat-chip-listbox>
                      <mat-chip>{{ transaction.category }}</mat-chip>
                    </mat-chip-listbox>
                  </td>
                </ng-container>

                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>Valor</th>
                  <td mat-cell *matCellDef="let transaction">
                    <span class="amount" [class]="transaction.type">
                      {{ formatCurrency(transaction.amount) }}
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let transaction">
                    <mat-chip [style.background-color]="getStatusInfo(transaction.status)?.color">
                      {{ getStatusInfo(transaction.status)?.label }}
                    </mat-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let transaction">
                    <button mat-icon-button [matMenuTriggerFor]="actionMenu">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #actionMenu="matMenu">
                      <button mat-menu-item (click)="editTransaction(transaction)">
                        <mat-icon>edit</mat-icon>
                        Editar
                      </button>
                      <button mat-menu-item>
                        <mat-icon>visibility</mat-icon>
                        Visualizar
                      </button>
                      <mat-divider></mat-divider>
                      <button mat-menu-item (click)="deleteTransaction(transaction.id)" class="delete-action">
                        <mat-icon>delete</mat-icon>
                        Excluir
                      </button>
                    </mat-menu>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="transactionColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: transactionColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Orçamentos -->
    <mat-tab label="Orçamentos">
      <div class="tab-content">
        <mat-card class="data-card">
          <mat-card-header>
            <mat-card-title>Controle de Orçamentos</mat-card-title>
            <mat-card-subtitle>{{ budgets.length }} orçamentos ativos</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="budgets-grid">
              <div *ngFor="let budget of budgets" class="budget-card" [class]="getBudgetStatus(budget)">
                <div class="budget-header">
                  <h3 class="budget-name">{{ budget.name }}</h3>
                  <mat-chip [class]="budget.status">{{ budget.status }}</mat-chip>
                </div>
                <div class="budget-category">{{ budget.category }}</div>
                <div class="budget-amounts">
                  <div class="amount-item">
                    <span class="amount-label">Orçado:</span>
                    <span class="amount-value">{{ formatCurrency(budget.allocated) }}</span>
                  </div>
                  <div class="amount-item">
                    <span class="amount-label">Gasto:</span>
                    <span class="amount-value">{{ formatCurrency(budget.spent) }}</span>
                  </div>
                  <div class="amount-item">
                    <span class="amount-label">Restante:</span>
                    <span class="amount-value" [class.negative]="budget.remaining < 0">
                      {{ formatCurrency(budget.remaining) }}
                    </span>
                  </div>
                </div>
                <div class="budget-progress">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="getBudgetUtilization(budget)"
                    [class]="getBudgetStatus(budget)">
                  </mat-progress-bar>
                  <span class="progress-text">{{ getBudgetUtilization(budget) }}% utilizado</span>
                </div>
                <div class="budget-alerts" *ngIf="budget.alerts.length > 0">
                  <div *ngFor="let alert of budget.alerts" class="alert-item" [class]="alert.type">
                    <mat-icon>{{ alert.type === 'warning' ? 'warning' : 'error' }}</mat-icon>
                    <span>{{ alert.message }}</span>
                  </div>
                </div>
                <div class="budget-actions">
                  <button mat-icon-button matTooltip="Editar">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button matTooltip="Relatório">
                    <mat-icon>assessment</mat-icon>
                  </button>
                  <button mat-icon-button matTooltip="Excluir">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Análises -->
    <mat-tab label="Análises">
      <div class="tab-content">
        <div class="charts-grid">
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>Receita Mensal</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas #revenueChart></canvas>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>Despesas por Categoria</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas #expenseChart></canvas>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>Lucratividade por Projeto</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas #profitChart></canvas>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>Fluxo de Caixa</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas #cashFlowChart></canvas>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>Controle de Orçamentos</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas #budgetChart></canvas>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="metrics-card">
            <mat-card-header>
              <mat-card-title>Métricas Financeiras</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="metrics-grid">
                <div class="metric-item">
                  <span class="metric-label">ROI Médio</span>
                  <span class="metric-value positive">+24.5%</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Margem de Lucro</span>
                  <span class="metric-value">{{ formatPercentage(financialReport.profitMargin) }}</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Ticket Médio</span>
                  <span class="metric-value">R$ 32.500</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Crescimento</span>
                  <span class="metric-value positive">+18.2%</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>

    <!-- Faturas -->
    <mat-tab label="Faturas">
      <div class="tab-content">
        <mat-card class="data-card">
          <mat-card-header>
            <mat-card-title>Gestão de Faturas</mat-card-title>
            <mat-card-subtitle>{{ invoices.length }} faturas registradas</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="invoices" class="invoices-table">
                <ng-container matColumnDef="number">
                  <th mat-header-cell *matHeaderCellDef>Número</th>
                  <td mat-cell *matCellDef="let invoice">
                    <strong>{{ invoice.number }}</strong>
                  </td>
                </ng-container>

                <ng-container matColumnDef="client">
                  <th mat-header-cell *matHeaderCellDef>Cliente</th>
                  <td mat-cell *matCellDef="let invoice">
                    <div class="client-cell">
                      <span class="client-name">{{ invoice.client }}</span>
                      <span class="project-name">{{ invoice.project }}</span>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>Valor</th>
                  <td mat-cell *matCellDef="let invoice">
                    <span class="amount">{{ formatCurrency(invoice.total) }}</span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="issueDate">
                  <th mat-header-cell *matHeaderCellDef>Emissão</th>
                  <td mat-cell *matCellDef="let invoice">{{ formatDate(invoice.issueDate) }}</td>
                </ng-container>

                <ng-container matColumnDef="dueDate">
                  <th mat-header-cell *matHeaderCellDef>Vencimento</th>
                  <td mat-cell *matCellDef="let invoice">
                    <span [class.overdue]="invoice.dueDate < currentDate && invoice.status !== 'paid'">
                      {{ formatDate(invoice.dueDate) }}
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let invoice">
                    <mat-chip [class]="invoice.status">
                      {{ invoice.status }}
                    </mat-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let invoice">
                    <button mat-icon-button [matMenuTriggerFor]="invoiceMenu">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #invoiceMenu="matMenu">
                      <button mat-menu-item>
                        <mat-icon>visibility</mat-icon>
                        Visualizar
                      </button>
                      <button mat-menu-item>
                        <mat-icon>edit</mat-icon>
                        Editar
                      </button>
                      <button mat-menu-item>
                        <mat-icon>print</mat-icon>
                        Imprimir
                      </button>
                      <button mat-menu-item>
                        <mat-icon>email</mat-icon>
                        Enviar por Email
                      </button>
                      <mat-divider></mat-divider>
                      <button mat-menu-item class="delete-action">
                        <mat-icon>delete</mat-icon>
                        Excluir
                      </button>
                    </mat-menu>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="invoiceColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: invoiceColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

<!-- Transaction Dialog -->
<div class="dialog-overlay" *ngIf="showTransactionDialog" (click)="showTransactionDialog = false">
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>Nova Transação</h2>
      <button mat-icon-button (click)="showTransactionDialog = false">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <form [formGroup]="transactionForm" (ngSubmit)="addTransaction()" class="transaction-form">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Tipo</mat-label>
          <mat-select formControlName="type" required>
            <mat-option *ngFor="let type of transactionTypes" [value]="type.value">
              <mat-icon [style.color]="type.color">{{ type.icon }}</mat-icon>
              {{ type.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Categoria</mat-label>
          <mat-select formControlName="category" required>
            <mat-option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Descrição</mat-label>
        <input matInput formControlName="description" required>
      </mat-form-field>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Valor</mat-label>
          <input matInput type="number" formControlName="amount" required>
          <span matPrefix>R$ </span>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Data</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="date" required>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Projeto</mat-label>
          <input matInput formControlName="project">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Cliente</mat-label>
          <input matInput formControlName="client">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Método de Pagamento</mat-label>
          <mat-select formControlName="paymentMethod" required>
            <mat-option *ngFor="let method of paymentMethods" [value]="method">
              {{ method }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Referência</mat-label>
          <input matInput formControlName="reference">
        </mat-form-field>
      </div>

      <div class="dialog-actions">
        <button mat-button type="button" (click)="showTransactionDialog = false">Cancelar</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="transactionForm.invalid">
          Salvar Transação
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Budget Dialog -->
<div class="dialog-overlay" *ngIf="showBudgetDialog" (click)="showBudgetDialog = false">
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>Novo Orçamento</h2>
      <button mat-icon-button (click)="showBudgetDialog = false">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <form [formGroup]="budgetForm" (ngSubmit)="addBudget()" class="budget-form">
      <mat-form-field appearance="outline">
        <mat-label>Nome do Orçamento</mat-label>
        <input matInput formControlName="name" required>
      </mat-form-field>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Categoria</mat-label>
          <mat-select formControlName="category" required>
            <mat-option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Valor Orçado</mat-label>
          <input matInput type="number" formControlName="allocated" required>
          <span matPrefix>R$ </span>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Período</mat-label>
          <mat-select formControlName="period" required>
            <mat-option value="monthly">Mensal</mat-option>
            <mat-option value="quarterly">Trimestral</mat-option>
            <mat-option value="yearly">Anual</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Data de Início</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate" required>
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Data de Fim</mat-label>
        <input matInput [matDatepicker]="endPicker" formControlName="endDate" required>
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>

      <div class="dialog-actions">
        <button mat-button type="button" (click)="showBudgetDialog = false">Cancelar</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="budgetForm.invalid">
          Criar Orçamento
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="isLoading">
  <mat-spinner></mat-spinner>
  <p>Carregando dados financeiros...</p>
</div>